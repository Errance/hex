#!/usr/bin/env tsx
/**
 * Ëá™Âä®ÂåñÊãÜÂàÜ hexagrams.ts ‰∏∫64‰∏™Áã¨Á´ãÊñá‰ª∂
 * 
 * ÂäüËÉΩÔºö
 * 1. ËØªÂèñ src/content/hexagrams.ts ÁöÑ hexagramContents Êï∞ÁªÑ
 * 2. ‰∏∫ÊØè‰∏™Âç¶ÁîüÊàêÁã¨Á´ãÊñá‰ª∂ src/content/hexagrams/all/{slug}.ts
 * 3. ÁîüÊàê src/content/hexagrams/meta.ts ÁöÑ HEXAGRAM_META Êï∞ÁªÑ
 * 4. ÁîüÊàê src/content/hexagrams/loader.ts ÁöÑ HEXAGRAM_MODULES Êò†Â∞ÑË°®
 */

import * as fs from 'fs';
import * as path from 'path';

// ÂØºÂÖ•ÂéüÂßãÊï∞ÊçÆÔºà‰ªéÂ§á‰ªΩÊñá‰ª∂Ôºâ
import { hexagramContents } from './hexagrams-backup';
import type { HexagramContent } from '../src/content/hexagrams/types';

const PROJECT_ROOT = path.join(__dirname, '..');
const OUTPUT_DIR = path.join(PROJECT_ROOT, 'src/content/hexagrams/all');
const META_FILE = path.join(PROJECT_ROOT, 'src/content/hexagrams/meta.ts');
const LOADER_FILE = path.join(PROJECT_ROOT, 'src/content/hexagrams/loader.ts');

/**
 * ÁîüÊàê slugÔºàÊ†ºÂºèÔºö01-qianÔºâ
 */
function generateSlug(hex: HexagramContent): string {
  const id = String(hex.id).padStart(2, '0');
  // Ê∏ÖÁêÜÊãºÈü≥ÔºåÂè™‰øùÁïôÂ∞èÂÜôÂ≠óÊØç
  const pinyin = hex.namePinyin
    .toLowerCase()
    .replace(/[^a-z]/g, '');
  return `${id}-${pinyin}`;
}

/**
 * ÁîüÊàêÂçï‰∏™Âç¶Ë±°Êñá‰ª∂ÂÜÖÂÆπ
 */
function generateHexagramFile(hex: HexagramContent, slug: string): string {
  // ‰ΩøÁî® JSON.stringify Êù•Â∫èÂàóÂåñÊï∞ÊçÆÔºåÁÑ∂ÂêéÊ∑ªÂä†Á±ªÂûãÂØºÂÖ•
  const jsonContent = JSON.stringify(hex, null, 2);
  
  return `// ${hex.nameZh} (${hex.name.en}) - Hexagram ${hex.id}
// Auto-generated from scripts/split-hexagrams.ts

import type { HexagramContent } from '../types';

const hexagram: HexagramContent = ${jsonContent};

export default hexagram;
`;
}

/**
 * ÁîüÊàê meta.ts Êñá‰ª∂ÂÜÖÂÆπ
 */
function generateMetaFile(hexagrams: HexagramContent[]): string {
  const metaItems = hexagrams.map(hex => {
    const slug = generateSlug(hex);
    return `  {
    id: ${hex.id},
    slug: '${slug}',
    name: ${JSON.stringify(hex.name)},
    nameZh: '${hex.nameZh}',
    namePinyin: '${hex.namePinyin}',
    trigramUpper: ${JSON.stringify(hex.trigramUpper)},
    trigramLower: ${JSON.stringify(hex.trigramLower)},
    symbolUpper: '${hex.symbolUpper}',
    symbolLower: '${hex.symbolLower}',
  }`;
  });

  return `// Hexagram meta information (lightweight index)
// Auto-generated by scripts/split-hexagrams.ts

import type { Localized } from './types';

export type HexagramMeta = {
  id: number;
  slug: string;
  name: Localized;
  nameZh: string;
  namePinyin: string;
  trigramUpper: Localized;
  trigramLower: Localized;
  symbolUpper: string;
  symbolLower: string;
};

export const HEXAGRAM_META: HexagramMeta[] = [
${metaItems.join(',\n')}
];

export function getHexagramMeta(id: number): HexagramMeta | undefined {
  return HEXAGRAM_META.find((h) => h.id === id);
}

export function getHexagramMetaBySlug(slug: string): HexagramMeta | undefined {
  return HEXAGRAM_META.find((h) => h.slug === slug);
}
`;
}

/**
 * ÁîüÊàê loader.ts Êñá‰ª∂ÂÜÖÂÆπ
 */
function generateLoaderFile(hexagrams: HexagramContent[]): string {
  const imports = hexagrams.map(hex => {
    const slug = generateSlug(hex);
    return `  ${hex.id}: () => import('./all/${slug}')`;
  });

  return `// Hexagram content loader with on-demand imports
// Auto-generated by scripts/split-hexagrams.ts

import type { HexagramContent, HexagramView, Lang } from './types';
import { getHexagramMeta } from './meta';

/**
 * Explicit module mapping for better bundler compatibility
 */
const HEXAGRAM_MODULES: Record<
  number,
  () => Promise<{ default: HexagramContent }>
> = {
${imports.join(',\n')}
};

/**
 * Load complete hexagram content (new API)
 */
export async function getHexagramContent(
  id: number
): Promise<HexagramContent | null> {
  const loader = HEXAGRAM_MODULES[id];
  if (!loader) {
    console.error(\`Hexagram \${id} not found in HEXAGRAM_MODULES\`);
    return null;
  }
  
  try {
    const mod = await loader();
    return mod.default;
  } catch (error) {
    console.error(\`Failed to load hexagram \${id}:\`, error);
    return null;
  }
}

/**
 * Get hexagram view (compatibility layer)
 * Maintains the same function signature and return structure as before
 */
export async function getHexagramView(
  id: number,
  lang: Lang
): Promise<HexagramView | null> {
  const content = await getHexagramContent(id);
  if (!content) return null;

  // Convert HexagramContent to flattened HexagramView structure
  return {
    id: content.id,
    name: content.name[lang],
    nameZh: content.nameZh,
    namePinyin: content.namePinyin,
    descriptionShort: content.descriptionShort[lang],
    trigramUpper: content.trigramUpper[lang],
    trigramLower: content.trigramLower[lang],
    symbolUpper: content.symbolUpper,
    symbolLower: content.symbolLower,
    judgement: content.judgement[lang],
    imageText: content.imageText[lang],
    lines: content.lines.map((line) => ({
      index: line.index,
      text: line.text[lang],
      original: line.original,
    })),
    summary: {
      general: content.initialSummary.general[lang],
      tone: content.initialSummary.tone,
      scenes: content.initialSummary.scenes
        ? {
            love: content.initialSummary.scenes.love?.[lang],
            career: content.initialSummary.scenes.career?.[lang],
            wealth: content.initialSummary.scenes.wealth?.[lang],
            health: content.initialSummary.scenes.health?.[lang],
          }
        : undefined,
    },
  };
}

/**
 * Preload hexagram content (optional optimization)
 */
export function preloadHexagram(id: number): void {
  const loader = HEXAGRAM_MODULES[id];
  if (loader) {
    loader().catch(err => console.error(\`Failed to preload hexagram \${id}:\`, err));
  }
}
`;
}

/**
 * ‰∏ªÊâßË°åÂáΩÊï∞
 */
async function main() {
  console.log('üöÄ Starting hexagram split process...\n');

  // 1. È™åËØÅËæìÂÖ•Êï∞ÊçÆ
  console.log(`üìä Found ${hexagramContents.length} hexagrams in source file`);
  
  if (hexagramContents.length !== 64) {
    console.error(`‚ùå Error: Expected 64 hexagrams, but found ${hexagramContents.length}`);
    process.exit(1);
  }

  // 2. Á°Æ‰øùËæìÂá∫ÁõÆÂΩïÂ≠òÂú®
  if (!fs.existsSync(OUTPUT_DIR)) {
    fs.mkdirSync(OUTPUT_DIR, { recursive: true });
    console.log(`üìÅ Created output directory: ${OUTPUT_DIR}`);
  }

  // 3. ÁîüÊàêÊØè‰∏™Âç¶Ë±°ÁöÑÁã¨Á´ãÊñá‰ª∂
  console.log('\nüìù Generating individual hexagram files...');
  const slugs: string[] = [];
  
  for (const hex of hexagramContents) {
    const slug = generateSlug(hex);
    slugs.push(slug);
    
    const fileName = `${slug}.ts`;
    const filePath = path.join(OUTPUT_DIR, fileName);
    const content = generateHexagramFile(hex, slug);
    
    fs.writeFileSync(filePath, content, 'utf-8');
    console.log(`  ‚úÖ ${fileName} (${hex.nameZh})`);
  }

  // 4. ÁîüÊàê meta.ts
  console.log('\nüìù Generating meta.ts...');
  const metaContent = generateMetaFile(hexagramContents);
  fs.writeFileSync(META_FILE, metaContent, 'utf-8');
  console.log(`  ‚úÖ meta.ts (${hexagramContents.length} entries)`);

  // 5. ÁîüÊàê loader.ts
  console.log('\nüìù Generating loader.ts...');
  const loaderContent = generateLoaderFile(hexagramContents);
  fs.writeFileSync(LOADER_FILE, loaderContent, 'utf-8');
  console.log(`  ‚úÖ loader.ts (${hexagramContents.length} dynamic imports)`);

  // 6. ÁîüÊàê index.tsÔºàÁªü‰∏ÄÂØºÂá∫Ôºâ
  console.log('\nüìù Generating index.ts...');
  const indexContent = `// Unified exports for hexagram content
// Auto-generated by scripts/split-hexagrams.ts

export * from './types';
export * from './meta';
export * from './loader';
`;
  const indexFile = path.join(PROJECT_ROOT, 'src/content/hexagrams/index.ts');
  fs.writeFileSync(indexFile, indexContent, 'utf-8');
  console.log(`  ‚úÖ index.ts`);

  // 7. ÊÄªÁªì
  console.log('\n' + '='.repeat(60));
  console.log('‚ú® Split completed successfully!');
  console.log('='.repeat(60));
  console.log(`üì¶ Generated files:`);
  console.log(`   - 64 hexagram files in: ${OUTPUT_DIR}`);
  console.log(`   - meta.ts: ${META_FILE}`);
  console.log(`   - loader.ts: ${LOADER_FILE}`);
  console.log(`   - index.ts: ${indexFile}`);
  console.log('\nüìã Next steps:');
  console.log('   1. Run: npm run build');
  console.log('   2. Test the application');
  console.log('   3. Update import paths in components');
  console.log('   4. Backup old hexagrams.ts ‚Üí hexagrams-old.ts');
  console.log('');
}

// ÊâßË°å
main().catch(error => {
  console.error('‚ùå Error during split process:', error);
  process.exit(1);
});

